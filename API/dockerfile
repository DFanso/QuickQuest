# Stage 1: Build the application
FROM node:18-alpine as build

# Define arguments
ARG MONGO_URI
ARG AWS_REGION
ARG AWS_BUCKET_NAME
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG COGNITO_USER_POOL_ID
ARG COGNITO_CLIENT_ID
ARG COGNITO_CLIENT_SECRET
ARG PAYPAL_CLIENT_ID
ARG PAYPAL_CLIENT_SECRET
ARG FRONTEND_URL
ARG BREVO_SMTP
ARG BREVO_SMTP_PORT
ARG BREVO_USER
ARG BREVO_PASS
ARG EMAIL_FROM_ADDRESS
ARG PAYPAL_REDIRECT_URI
ARG COGNITO_CALLBACK_URL
ARG COGNITO_DOMAIN


# Set environment variables
ENV MONGO_URI=${MONGO_URI}
ENV AWS_REGION=${AWS_REGION} 
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME} 
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} 
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} 
ENV COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID} 
ENV COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID} 
ENV COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
ENV PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
ENV PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
ENV FRONTEND_URL=${FRONTEND_URL}
ENV BREVO_SMTP=${BREVO_SMTP}
ENV BREVO_SMTP_PORT=${BREVO_SMTP_PORT}
ENV BREVO_USER=${BREVO_USER}
ENV BREVO_PASS=${BREVO_PASS}
ENV EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS}
ENV PAYPAL_REDIRECT_URI=${PAYPAL_REDIRECT_URI}
ENV COGNITO_CALLBACK_URL=${COGNITO_CALLBACK_URL}
ENV COGNITO_DOMAIN=${COGNITO_DOMAIN}

# Create app directory
WORKDIR /usr/src/app

# Install app dependencies
# A wildcard is used to ensure both package.json AND package-lock.json are copied
COPY package*.json ./

RUN npm install

# Bundle app source
COPY . .

RUN npm run build
# RUN npm run test

# Stage 2: Run the application
FROM node:18-alpine

# Repeat ARG instructions
ARG MONGO_URI
ARG AWS_REGION
ARG AWS_BUCKET_NAME
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG COGNITO_USER_POOL_ID
ARG COGNITO_CLIENT_ID
ARG COGNITO_CLIENT_SECRET
ARG PAYPAL_CLIENT_ID
ARG PAYPAL_CLIENT_SECRET
ARG FRONTEND_URL
ARG BREVO_SMTP
ARG BREVO_SMTP_PORT
ARG BREVO_USER
ARG BREVO_PASS
ARG EMAIL_FROM_ADDRESS
ARG PAYPAL_REDIRECT_URI
ARG COGNITO_CALLBACK_URL
ARG COGNITO_DOMAIN

# Set environment variables
ENV MONGO_URI=${MONGO_URI}
ENV AWS_REGION=${AWS_REGION} 
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME} 
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} 
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} 
ENV COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID} 
ENV COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID} 
ENV COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
ENV PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
ENV PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
ENV FRONTEND_URL=${FRONTEND_URL}
ENV BREVO_SMTP=${BREVO_SMTP}
ENV BREVO_SMTP_PORT=${BREVO_SMTP_PORT}
ENV BREVO_USER=${BREVO_USER}
ENV BREVO_PASS=${BREVO_PASS}
ENV EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS}
ENV PAYPAL_REDIRECT_URI=${PAYPAL_REDIRECT_URI}
ENV COGNITO_CALLBACK_URL=${COGNITO_CALLBACK_URL}
ENV COGNITO_DOMAIN=${COGNITO_DOMAIN}

WORKDIR /usr/src/app
COPY --from=build /usr/src/app/dist ./dist
COPY --from=build /usr/src/app/node_modules ./node_modules
COPY --from=build /usr/src/app/package*.json ./

EXPOSE 9000
CMD ["node", "dist/main"]
